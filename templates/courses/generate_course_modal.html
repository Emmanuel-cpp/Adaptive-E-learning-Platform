<!-- templates/courses/generate_course_modal.html -->
<div id="generate-course-modal" class="modal" style="display: none;">
    <div class="modal-overlay" onclick="closeGenerateCourseModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h2>Generate C++ Lessons Using AI</h2>
            <button class="modal-close" onclick="closeGenerateCourseModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="generate-course-form">
                {% csrf_token %}
                
                <div class="form-group">
                    <label for="course-name">Lesson Topic</label>
                    <input type="text" id="course-name" name="name" class="form-control" 
                           placeholder="e.g., Introduction to C++" required>
                    <small class="help-text">This topic will be used to generate C++ lessons.</small>
                </div>
                
                <div class="form-group">
                    <label for="course-description">Description (Optional)</label>
                    <textarea id="course-description" name="description" class="form-control" 
                              placeholder="Brief description of your lesson" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="chapter-count">Number of Chapters</label>
                    <input type="number" id="chapter-count" name="noOfChapters" class="form-control" 
                           min="1" max="10" value="3" required>
                    <small class="help-text">Recommended: 3-5 chapters for optimal learning</small>
                </div>
                
                <div class="form-group">
                    <label for="difficulty-level">Difficulty Level</label>
                    <select id="difficulty-level" name="level" class="form-control" required>
                        <option value="beginner" selected>Beginner</option>
                        <option value="moderate">Moderate</option>
                        <option value="advanced">Advanced</option>
                    </select>
                </div>
                
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeGenerateCourseModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span id="generate-icon">âœ¨</span>
                        <span id="generate-text">Generate Lessons</span>
                        <span id="generate-loader" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i> Generating...
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* Modal styling */
.modal {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    display: flex; align-items: center; justify-content: center;
    z-index: 1000;
}
.modal-overlay {
    position: absolute; top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
}
.modal-content {
    background: #fff;
    border-radius: 12px;
    width: 90%; max-width: 500px;
    max-height: 90vh; overflow-y: auto;
    z-index: 1001; position: relative;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
}
.modal-header { padding: 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
.modal-header h2 { margin: 0; font-family: 'Montserrat', sans-serif; color: #333; }
.modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
.modal-body { padding: 20px; }
.form-group { margin-bottom: 20px; }
.form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #555; }
.form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-family: 'Poppins', sans-serif; }
.form-control:focus { outline: none; border-color: #0d47a1; box-shadow: 0 0 0 3px rgba(13,71,161,0.1); }
.form-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
.help-text { display: block; margin-top: 5px; font-size: 0.8rem; color: #888; }
</style>

<script>
function openGenerateCourseModal() {
    document.getElementById('generate-course-modal').style.display = 'flex';
    document.getElementById('generate-course-form').reset();
}

function closeGenerateCourseModal() {
    document.getElementById('generate-course-modal').style.display = 'none';
}

function getCSRFToken() {
    const cookieValue = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
    return cookieValue;
}

function resetGenerateButton() {
    document.getElementById('generate-icon').style.display = 'inline';
    document.getElementById('generate-text').style.display = 'inline';
    document.getElementById('generate-loader').style.display = 'none';
}

document.getElementById('generate-course-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    document.getElementById('generate-icon').style.display = 'none';
    document.getElementById('generate-text').style.display = 'none';
    document.getElementById('generate-loader').style.display = 'inline';

    const formData = {
        name: document.getElementById('course-name').value,
        description: document.getElementById('course-description').value,
        noOfChapters: parseInt(document.getElementById('chapter-count').value),
        level: document.getElementById('difficulty-level').value,
        includeVideo: document.getElementById('include-video').checked
    };

    try {
        const response = await fetch('{% url "generate_course" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
            body: JSON.stringify(formData)
        });
        const data = await response.json();
        if (data.success) {
            window.location.href = `/learning/?generated_course_id=${data.course_id}&topic_id=${data.first_topic_id}`;
        } else {
            alert('Error generating lessons: ' + data.error);
            resetGenerateButton();
        }
    } catch (error) {
        alert('Error generating lessons: ' + error.message);
        resetGenerateButton();
    }
});

// Close modal on click outside or Escape
document.getElementById('generate-course-modal').addEventListener('click', e => { if(e.target===this) closeGenerateCourseModal(); });
document.addEventListener('keydown', e => { if(e.key==='Escape') closeGenerateCourseModal(); });
</script>
