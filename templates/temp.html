try {
        const response = await fetch('/api/complete-generated-topic/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
                topic_id: parseInt(topicId),
                answers: userAnswers
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Show results section
            resultsDiv.style.display = 'block';
            
            if (data.passed) {
                // User passed - show success and proceed to next topic
                feedbackDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h4>Congratulations! You passed with ${data.score}%</h4>
                        <p>${data.ai_feedback}</p>
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-primary" onclick="proceedToNextTopic()">
                            Continue to Next Lesson <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                `;
                
                // Store next topic ID for the proceed function
                window.nextTopicId = data.next_topic_id;
            } else {
                // User failed - show feedback and automatically adapt
                let resourcesHtml = '';
                if (data.remedial_resources && data.remedial_resources.length > 0) {
                    resourcesHtml = `
                        <div class="mt-3">
                            <h5>Recommended Resources:</h5>
                            <ul class="list-group">
                                ${data.remedial_resources.map(resource => `
                                    <li class="list-group-item">
                                        <a href="${resource.url}" target="_blank" class="text-primary">
                                            <i class="fas fa-external-link-alt me-2"></i>${resource.title}
                                        </a>
                                        <small class="text-muted d-block">${resource.type.replace('_', ' ')}</small>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                feedbackDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <h4>You scored ${data.score}% - Let's try a different approach</h4>
                        <p>${data.ai_feedback}</p>
                        ${resourcesHtml}
                        <div class="text-center mt-3">
                            <button class="btn btn-primary" onclick="proceedToAdaptedLesson()">
                                Okay, let's continue <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                // Store regenerated topic ID for the proceed function
                window.regeneratedTopicId = data.regenerated_topic_id;
            }
            
        } else {
            // Error handling
            feedbackDiv.innerHTML = <div class="alert alert-danger">Error: ${data.error}</div>;
        }
        
        feedbackDiv.style.display = 'block';
        
    } catch (error) {
        console.error('Error:', error);
        feedbackDiv.innerHTML = '<div class="alert alert-danger">An error occurred. Please try again.</div>';
        feedbackDiv.style.display = 'block';
    }
}

// NEW: Function to proceed to next topic for successful students
function proceedToNextTopic() {
    if (window.nextTopicId) {
        window.location.href = /learning/?generated_course_id=${courseId}&topic_id=${window.nextTopicId};
    } else {
        // No next topic - course completed
        window.location.href = '/dashboard';
    }
}

// NEW: Function to proceed to adapted lesson for struggling students
function proceedToAdaptedLesson() {
    if (window.regeneratedTopicId) {
        // Redirect to the automatically generated simpler lesson
        window.location.href = /learning/?generated_course_id=${courseId}&topic_id=${window.regeneratedTopicId};
    } else {
        // Fallback: retry the same lesson if regeneration failed
        showToast('Unable to generate adapted content. Please try again.', 'error');
        window.location.reload();
    }
}