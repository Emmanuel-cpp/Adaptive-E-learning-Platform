<body>
   <!-- Header -->
    <header>
        <div class="container">
            <nav>
                <div class="logo-container">
                    <button class="menu-toggle" id="mobile-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <a href="#" class="logo">
                        <div class="logo-icon">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <span class="logo-text">CBU Learn</span>
                    </a>
                </div>
                
                <div class="nav-buttons">
                    <a href="{% url 'dashboard' %}" class="nav-btn login-btn">
                        <i class="fas fa-user"></i> Me
                    </a>
                    <a href="{% url 'logout' %}" class="nav-btn register-btn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </div>
            </nav>
        </div>
    </header>

    <!-- Learning Layout -->
    <div class="learning-container">
        <div id="sidebar-overlay" class="sidebar-overlay"></div>

        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2 class="course-title">{{ course.title }}</h2>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ progress_percentage }}%"></div>
                </div>
                <div class="progress-text">{{ progress_percentage }}% Complete</div>
            </div>

            <ul class="module-list">
                {% if is_generated %}
                    {% for chapter in course.chapters.all %}
                        <li class="module-item {% if chapter == module %}active{% endif %}">
                            {% if chapter.topics.first %}
                                <a href="{% url 'learning_default' %}?generated_course_id={{ course.id }}&topic_id={{ chapter.topics.first.id }}" class="module-link">
                                    <div class="module-icon">
                                        <i class="fas fa-play"></i>
                                    </div>
                                    <span class="module-title">{{ chapter.title }}</span>
                                </a>
                            {% else %}
                                <span class="module-link disabled" style="opacity:0.6; cursor:not-allowed;">
                                    <div class="module-icon">
                                        <i class="fas fa-ban"></i>
                                    </div>
                                    <span class="module-title">{{ chapter.title }} (No topics)</span>
                                </span>
                            {% endif %}
                        </li>
                    {% endfor %}
                {% else %}
                    {% for mod in course.modules.all %}
                        <li class="module-item {% if mod == module %}active{% endif %}">
                            {% if mod.lessons.first %}
                                <a href="{% url 'learning' lesson_id=mod.lessons.first.id %}" class="module-link">
                                    <div class="module-icon">
                                        <i class="fas fa-play"></i>
                                    </div>
                                    <span class="module-title">{{ mod.title }}</span>
                                    <div class="module-status">
                                        {% if mod in completed_modules %}âœ“{% endif %}
                                    </div>
                                </a>
                            {% else %}
                                <span class="module-link disabled" style="opacity:0.6; cursor:not-allowed;">
                                    <div class="module-icon">
                                        <i class="fas fa-ban"></i>
                                    </div>
                                    <span class="module-title">{{ mod.title }} (No lessons)</span>
                                </span>
                            {% endif %}
                        </li>
                    {% endfor %}
                {% endif %}
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="content-area">
            <div class="lesson-content">
                <h2>{{ lesson.title }}</h2>
                {% if is_generated %}
                    <div class="generated-content">{{ lesson.content|markdown }}</div>
                    
                    <!-- Fixed quiz display condition -->
                    {% if is_generated and quiz_questions %}
                        <div id="quiz-section" class="quiz-container mb-4 p-4 rounded shadow-sm">
                            <h3 class="text-primary-dark font-montserrat font-bold">Quiz</h3>
                            <form id="quiz-form" data-topic-id="{{ lesson.id }}" data-is-regenerated="{{ lesson.is_regenerated|yesno:'true,false' }}">
                                {% csrf_token %}
                                {% for question in quiz_questions %}
                                    <div class="quiz-question mb-3" data-question-id="{{ question.id }}">
                                        <p class="font-poppins font-medium">{{ forloop.counter }}. {{ question.question_text }}</p>
                                        <div class="options mt-2">
                                            {% for answer in question.answers.all %}
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="question-{{ question.id }}" 
                                                           id="answer-{{ answer.id }}" value="{{ answer.option_key }}" required>
                                                    <label class="form-check-label" for="answer-{{ answer.id }}">
                                                        {{ answer.answer_text }}
                                                    </label>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endfor %}
                                <button type="submit" class="btn btn-primary mt-3" id="quiz-submit-btn">Submit Quiz</button>
                            </form>
                            <div id="quiz-feedback" class="mt-3" style="display: none;"></div>
                        </div>
                    {% endif %}
                {% else %}
                    {{ lesson.content|safe }}
                {% endif %}
            </div>
            
            <!-- Enhanced Navigation Buttons -->
            <div class="content-footer">
                {% if previous_lesson %}
                    {% if is_generated %}
                        <a href="{% url 'learning_default' %}?generated_course_id={{ course.id }}&topic_id={{ previous_lesson.id }}" class="nav-btn outline">
                            <i class="fas fa-arrow-left"></i> Previous: {{ previous_lesson.title }}
                        </a>
                    {% else %}
                        <a href="{% url 'learning' lesson_id=previous_lesson.id %}" class="nav-btn outline">
                            <i class="fas fa-arrow-left"></i> Previous: {{ previous_lesson.title }}
                        </a>
                    {% endif %}
                {% else %}
                    <span></span> <!-- Empty spacer for alignment -->
                {% endif %}

                {% if next_lesson %}
                    {% if is_generated %}
                        {% if topic_completed and completion.score >= 50 %}
                            <a href="{% url 'learning_default' %}?generated_course_id={{ course.id }}&topic_id={{ next_lesson.id }}" class="nav-btn">
                                Next: {{ next_lesson.title }} <i class="fas fa-arrow-right"></i>
                            </a>
                        {% else %}
                            <button class="nav-btn" disabled title="Complete current lesson with a passing grade to proceed">
                                Next: {{ next_lesson.title }} <i class="fas fa-lock"></i>
                            </button>
                        {% endif %}
                    {% else %}
                        <a href="{% url 'learning' lesson_id=next_lesson.id %}" class="nav-btn">
                            Next: {{ next_lesson.title }} <i class="fas fa-arrow-right"></i>
                        </a>
                    {% endif %}
                {% elif has_next_chapter %}
                    {% if is_generated and topic_completed and completion.score >= 50 %}
                        <a href="{% url 'learning_default' %}?generated_course_id={{ course.id }}&topic_id={{ next_chapter.topics.first.id }}" class="nav-btn">
                            Next Chapter: {{ next_chapter.title }} <i class="fas fa-arrow-right"></i>
                        </a>
                    {% else %}
                        <button class="nav-btn" disabled title="Complete current lesson with a passing grade to proceed">
                            Next Chapter: {{ next_chapter.title }} <i class="fas fa-lock"></i>
                        </button>
                    {% endif %}
                {% else %}
                    {% if is_generated and topic_completed and completion.score >= 50 %}
                        <a href="{% url 'dashboard' %}" class="nav-btn success">
                            Complete Course <i class="fas fa-trophy"></i>
                        </a>
                    {% else %}
                        <button class="nav-btn" disabled title="Complete current lesson with a passing grade to complete the course">
                            Complete Course <i class="fas fa-lock"></i>
                        </button>
                    {% endif %}
                {% endif %}
            </div>

            <!-- Enhanced Completion Section -->
            <div class="completion-section" style="margin: 40px 0; text-align: center;">
                {% if is_generated %}
                    {% if not topic_completed %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Complete the quiz to mark this topic as completed.
                        </div>
                    {% elif completion.score < 50 %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> You completed this topic but didn't pass. Consider reviewing the material.
                        </div>
                    {% else %}
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> You've successfully completed this topic with a score of {{ completion.score }}%.
                        </div>
                    {% endif %}
                {% else %}
                    <form method="post" action="{% url 'complete_lesson' lesson_id=lesson.id %}">
                        {% csrf_token %}
                        <button type="submit" class="nav-btn complete-btn" style="background: linear-gradient(135deg, #4caf50, #45a049);">
                            <i class="fas fa-check-circle"></i> Mark Lesson as Completed
                        </button>
                    </form>
                {% endif %}
            </div>
            
            <!-- Quiz Results Section -->
            <div id="quiz-results" style="display: none;">
                <div class="quiz-feedback" id="quiz-feedback"></div>
                
                <div id="remedial-resources" class="mt-4" style="display: none;">
                    <h4>Recommended Resources to Improve Your Understanding:</h4>
                    <div class="resource-list" id="resource-list"></div>
                </div>
                
                <div id="alternative-content" class="mt-4" style="display: none;">
                    <h4>Simplified Explanation:</h4>
                    <div class="simplified-content" id="simplified-content"></div>
                </div>
                
                <div class="action-buttons mt-4">
                    <button id="retry-quiz" class="btn btn-primary" style="display: none;">
                        <i class="fas fa-redo"></i> Retry Quiz
                    </button>
                    <a id="next-topic-btn" class="btn btn-success" style="display: none;">
                        Continue to Next Topic <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
            </div>
        </main>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="copyright">
                <p>&copy; 2025 Copperbelt University - School of ICT. All rights reserved.</p>
                <p>Adaptive E-Learning Platform for First Year ICT Students</p>
            </div>
        </div>
    </footer>

    <!-- JavaScript remains the same as in your original code -->
    <script>
    <script>
// Update the validateQuiz function to handle the new response format
// Update the validateQuiz function to handle regeneration
async function validateQuiz() {
    const quizForm = document.getElementById('quiz-form');
    const topicId = quizForm.dataset.topicId;
    const isRegenerated = quizForm.dataset.isRegenerated === 'true'; // Check if this is already a regenerated topic
    const submitBtn = document.getElementById('quiz-submit-btn');
    const feedbackDiv = document.getElementById('quiz-feedback');
    const resultsDiv = document.getElementById('quiz-results');
    
    // Collect answers
    const userAnswers = {};
    let allAnswered = true;
    
    document.querySelectorAll('.quiz-question').forEach(questionDiv => {
        const questionId = questionDiv.dataset.questionId;
        const selectedOption = questionDiv.querySelector('input:checked');
        
        if (selectedOption) {
            userAnswers[questionId] = selectedOption.value;
        } else {
            allAnswered = false;
            questionDiv.style.border = "2px solid #ff6b6b";
        }
    });
    
    if (!allAnswered) {
        feedbackDiv.innerHTML = '<div class="alert alert-warning">Please answer all questions before submitting.</div>';
        feedbackDiv.style.display = 'block';
        return;
    }
    
    // Disable submit button to prevent multiple submissions
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...';
    
    try {
        const response = await fetch('/api/complete-generated-topic/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
                topic_id: parseInt(topicId),
                answers: userAnswers,
                is_retry: window.isRetryAttempt || false // Track if this is a retry
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Show results section
            resultsDiv.style.display = 'block';
            
            // Display feedback based on pass/fail status
            if (data.passed) {
                feedbackDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h4>Congratulations! You passed with ${data.score}%</h4>
                        <p>${data.ai_feedback}</p>
                    </div>
                `;
                
                // Show next topic button after a delay
                setTimeout(() => {
                    if (data.next_topic_id) {
                        const nextBtn = document.createElement('a');
                        nextBtn.href = `/learning/?generated_course_id=${data.course_id}&topic_id=${data.next_topic_id}`;
                        nextBtn.className = 'btn btn-primary mt-3';
                        nextBtn.innerHTML = 'Continue to Next Topic <i class="fas fa-arrow-right"></i>';
                        feedbackDiv.appendChild(nextBtn);
                    } else {
                        const completeBtn = document.createElement('a');
                        completeBtn.href = '/dashboard';
                        completeBtn.className = 'btn btn-success mt-3';
                        completeBtn.innerHTML = 'Course Completed! Return to Dashboard';
                        feedbackDiv.appendChild(completeBtn);
                    }
                }, 3000);
            } else {
                // Student failed - show appropriate options based on whether this is a regenerated topic
                let retryHtml = '';
                
                if (isRegenerated) {
                    // For regenerated topics, only show retry option
                    retryHtml = `
                        <div class="mt-3 d-flex gap-2 justify-content-center flex-wrap">
                            <button class="btn btn-primary" onclick="retryQuiz()">
                                <i class="fas fa-redo me-2"></i>Retry Quiz
                            </button>
                        </div>
                    `;
                } else {
                    // For original topics, show both retry and regenerate options
                    retryHtml = `
                        <div class="mt-3 d-flex gap-2 justify-content-center flex-wrap">
                            <button class="btn btn-primary" onclick="retryQuiz()">
                                <i class="fas fa-redo me-2"></i>Retry Same Quiz
                            </button>
                            <button class="btn btn-warning" onclick="regenerateSimplerLesson(${data.course_id}, ${topicId})">
                                <i class="fas fa-graduation-cap me-2"></i>Get Simpler Lesson
                            </button>
                        </div>
                    `;
                }
                
                // Show remedial resources
                let resourcesHtml = '';
                if (data.remedial_resources && data.remedial_resources.length > 0) {
                    resourcesHtml = `
                        <div class="mt-4">
                            <h5>Recommended Resources to Improve Your Understanding:</h5>
                            <ul class="list-group">
                                ${data.remedial_resources.map(resource => `
                                    <li class="list-group-item">
                                        <a href="${resource.url}" target="_blank" class="text-primary">
                                            <i class="fas fa-external-link-alt me-2"></i>${resource.title}
                                        </a>
                                        <small class="text-muted d-block">${resource.type.replace('_', ' ')}</small>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                feedbackDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <h4>You scored ${data.score}% - Review Needed</h4>
                        <p>${data.ai_feedback}</p>
                        <p class="mt-3">You need to score at least 50% to proceed to the next lesson.</p>
                        ${resourcesHtml}
                        ${retryHtml}
                    </div>
                `;
            }
            feedbackDiv.style.display = 'block';
            
        } else {
            feedbackDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
            feedbackDiv.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Submit Quiz';
        }
    } catch (error) {
        console.error('Error:', error);
        feedbackDiv.innerHTML = '<div class="alert alert-danger">An error occurred. Please try again.</div>';
        feedbackDiv.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Submit Quiz';
    }
}


function retryQuiz() {
    console.log('Retry quiz clicked');
    // Set flag to indicate this is a retry attempt
    window.isRetryAttempt = true;
    
    // Reload the page to retry the same quiz
    window.location.reload();
}

async function regenerateSimplerLesson(courseId, topicId) {
    console.log('Regenerate simpler lesson clicked', courseId, topicId);
    
    // Show loading state
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    button.disabled = true;
    
    try {
        const csrfToken = getCookie('csrftoken');
        if (!csrfToken) {
            throw new Error('CSRF token not found');
        }
        
        console.log('CSRF token found');
        
        const response = await fetch('/api/regenerate-topic/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify({
                course_id: courseId,
                topic_id: topicId
            })
        });
        
        console.log('Response status:', response.status);
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('Non-JSON response:', text);
            throw new Error('Server returned non-JSON response: ' + text);
        }
        
        const data = await response.json();
        console.log('Regenerate response:', data);
        
        if (data.success) {
            // Redirect to the regenerated topic
            window.location.href = `/learning/?generated_course_id=${courseId}&topic_id=${data.regenerated_topic_id}`;
        } else {
            alert('Error: ' + data.error);
            // Optionally, offer to retry the same quiz
            if (confirm('Would you like to retry the same quiz instead?')) {
                retryQuiz();
            }
        }
    } catch (error) {
        console.error('Detailed error:', error);
        console.error('Error name:', error.name);
        console.error('Error message:', error.message);
        console.error('Error stack:', error.stack);
        alert('An error occurred while generating the simplified lesson: ' + error.message);
    } finally {
        // Restore button state
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Function to retry with a simplified topic
function retryWithSimplifiedTopic(topicId) {
    // Set flag to indicate this is a retry attempt
    window.isRetryAttempt = true;
    
    // Redirect to the simplified topic
    const url = new URL(window.location.href);
    url.searchParams.set('topic_id', topicId);
    window.location.href = url.toString();
}

// Function to retry the same quiz
function retryQuiz() {
    // Set flag to indicate this is a retry attempt
    window.isRetryAttempt = true;
    
    // Reload the page to retry the same quiz
    window.location.reload();
}

document.addEventListener('DOMContentLoaded', function() {
    const quizForm = document.getElementById('quiz-form');
    if (quizForm) {
        console.log('Quiz form found, adding event listener');
        quizForm.addEventListener('submit', function(event) {
            event.preventDefault();
            validateQuiz();
        });
    } else {
        console.log('Quiz form not found');
    }
});

// Quiz functionality with try-again feature

 // Mobile sidebar toggle functionality
        document.addEventListener('DOMContentLoaded', function() {
            const mobileToggle = document.getElementById('mobile-toggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            
            // Toggle sidebar function
            function toggleSidebar() {
                sidebar.classList.toggle('active');
                sidebarOverlay.classList.toggle('active');
                
                // Change icon based on state
                if (sidebar.classList.contains('active')) {
                    mobileToggle.innerHTML = '<i class="fas fa-times"></i>';
                } else {
                    mobileToggle.innerHTML = '<i class="fas fa-bars"></i>';
                }
            }
            
            // Add event listeners
            mobileToggle.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);
            
            // Close sidebar when clicking on a module item (mobile only)
            if (window.innerWidth < 768) {
                document.querySelectorAll('.module-item').forEach(item => {
                    item.addEventListener('click', function() {
                        sidebar.classList.remove('active');
                        sidebarOverlay.classList.remove('active');
                        mobileToggle.innerHTML = '<i class="fas fa-bars"></i>';
                    });
                });
            }
        });

</script>
    </script>
</body>